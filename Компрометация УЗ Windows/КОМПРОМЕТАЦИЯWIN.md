# ИНЦИДЕНТ: КОМПРОМЕТАЦИЯ УЧЕТНОЙ ЗАПИСИ WINDOWS



<details>
<summary> Основные сведения об инциденте (нажмите, чтобы развернуть) </summary>
	
Компрометация учетной записи Windows – это ситуация, когда злоумышленник получает несанкционированный доступ к учетной записи пользователя Windows. Это может иметь серьезные последствия, такие как кража личных данных, финансовый ущерб, потеря контроля над критичными хостами и т.д. 

Существует множество способов, с помощью которых злоумышленники могут скомпрометировать вашу учетную запись Windows. Вот некоторые из наиболее распространенных:

- Фишинг: Злоумышленники могут отправить вам электронное письмо или сообщение, которое выглядит как вполне легитимное. В сообщении могут попросить перейти по ссылке или открыть вложение, которое содержит вредоносное ПО. Если нажать на ссылку или открыть вложение, вредоносное ПО может быть установлено на вашем компьютере и привести к компрометации.

- Брутфорс: Злоумышленники могут использовать программное обеспечение для автоматического перебора различных паролей, пока не найдут правильный.

- Атаки с использованием социальной инженерии: Злоумышленники могут использовать методы социальной инженерии, чтобы обманом заставить вас предоставить им свои учетные данные.

Более подробно об этих и других векторах компрометации можно прочитать в соответствующей ветке.


<details>
<summary> Статья по расследованию компрометации ОС (нажмите, чтобы развернуть)  </summary>
	
https://www.usenix.org/legacy/publications/login/2005-04/openpdfs/malware0504.pdf  
	
	
	
### Исследование подозрительной активности в системе

Иногда бывает очевидно, что хост взломан (например, когда сайт подвергается дефейсу). В других случаях обнаруживается подозрительное поведение, требующее дальнейшего расследования. Эта активность может быть результатом взлома, вируса, червя, шпионской программы или чего-то более безобидного.
	
Если подозрительная активность является следствием взлома, возможно, потребуется связаться с правоохранительными органами (в зависимости от политики вашей организации). По этой причине важно сохранить энергозависимые данные и документировать каждый ваш шаг.
	
Инструменты, описанные в этой статье, можно использовать для документирования текущего состояния системы, которая была взломана, или для исследования системы, которая ведет себя подозрительно.
	
> Недавно меня вызвали для расследования двух компьютеров под управлением Windows, которые демонстрировали подозрительное поведение. Первым делом я создал компакт-диск с несколькими инструментами, которые, по моему мнению, будут полезны для анализа системы и документирования ее состояния. Как оказалось, данные компьютеры были взломаны не злоумышленником, а двумя разными червями; эти две системы не были должным образом пропатчены.
	
Начало работы
	
Важно при исследовании любой системы (Windows, UNIX или другой) собрать списки пользователей, вошедших в систему, запущенных процессов и сетевых подключений. Системным администраторам следует использовать эти инструменты на свежеустановленных системах и на уже работающих системах, чтобы определить, как выглядит нормальная система. Если вы не знаете, что должно быть в вашей системе, очень сложно понять, чего там быть не должно.
	
После сбора базовой информации я проверяю реестр Windows и папки автозагрузки Windows, чтобы узнать, что запускается вместе с системой. Иногда бывает легко определить, что на самом деле представляет собой каждая из программ, запланированных к автоматическому запуску. К сожалению, многие легальные поставщики программного обеспечения любят делать глупости, такие как размещение исполняемого файла со странным названием в C:\windows или C:\windows\system32. Это может затруднить определение того, является ли программа легитимной. Лучше всего поискать имя файла в Google и посмотреть, что получится.
	
Инструмент Reg, описанный ниже, можно использовать для выгрузки нужных ключей из реестра. Любые нежелательные записи можно удалить с помощью Regedit или, в Windows XP, Msconfig.  Настоятельно рекомендуется использовать Msconfig в системах XP, поскольку он позволяет снять флажок с записи, но при желании восстановить ее позже. Если вы используете Regedit, сделайте резервную копию реестра перед удалением чего-либо. Также, вместо того чтобы удалять любые программы, на которые ссылаются эти записи, переместите и/или переименуйте их, чтобы не потерять то, что вам нужно. Администраторам следует попытаться ознакомиться с программным обеспечением, которое должно автоматически запускаться на их серверах и рабочих станциях. Опять же, трудно определить, что является аномальным, если вы не знаете, что является нормальным.
	
Хороший подход при исследовании системы заключается в том, чтобы искать все, что не должно там находиться. Это включает в себя шпионское ПО, черви, бэкдоры и т.д. Централизованно управляемая антивирусная программа - хороший способ обнаружить большое количество вредоносных программ, как только они попадают в систему, но она не обнаружит всё. Netcat, например, не является вредоносным ПО и не будет обнаружен антивирусной программой, но его можно использовать для привязки cmd.exe к порту для использования в качестве бэкдора.
	
Эта статья ограничивается обсуждением инструментов и процедур, которые могут помочь определить, взломана ли система. Реагирование на взлом - еще более масштабная проблема. Тем не менее, политика реагирования, одобренная руководством, должна быть разработана до того, как произойдет инцидент.
	
Некоторые важные моменты, которые необходимо решить, включают то, кто отвечает за техническое реагирование, как будут обрабатываться доказательства, кто принимает решение о том, следует ли обращаться в правоохранительные органы, и имеет ли значение, произошло ли вторжение изнутри или извне вашей организации.
	
Также полезно узнать у государственных органов / регуляторов, что они хотят, чтобы вы сделали в случае взлома. В какой момент они хотят, чтобы с ними связались? Как вам следует действовать? Как сохранить возможные доказательства? С кем из них контактировать? При обращении в полицию после взлома, вероятнее всего не стоит рассчитывать на компетенции сотрудников в области ИБ.
	
- Reg - это утилита Windows, которую можно использовать для извлечения данных из реестра Windows. Многие вредоносные программы добавляют запись в реестр для автоматического запуска при перезагрузке компьютера. В большинстве случаев (если вы сейчас ничего не устанавливаете) ключи RunOnce и RunOnceEx должны быть пустыми. Проверьте все программы, перечисленные в ключах Run, и убедитесь, что они являются законным программным обеспечением.
	
- Sysinternals - Handle - это командная утилита, которая показывает открытые дескрипторы для каждого процесса в системе. При использовании без опций, Handle отображает только открытые дескрипторы файлов. При использовании с опцией -a, Handle показывает открытые дескрипторы для всех объектов, включая файлы, ключи реестра, процессы, порты и семафоры. Для удобства я рекомендую дампировать все открытые дескрипторы в один файл, а затем только открытые дескрипторы файлов - во второй. Handle очень полезна для того, чтобы понять, что на самом деле делает программа.
	
- Sysinternals - ListDLLs - это консольная утилита, которая отображает файлы DLL, загруженные каждым запущенным в системе процессом. Утилита показывает полный путь к каждой DLL.  Информация о пути особенно полезна, поскольку она помогает определить, с каким приложением или службой связан тот или иной процесс.
	
- Sysinternals - Tcpvcon отображает список всех установленных TCP-соединений вместе с их процессами-владельцами. При использовании с опцией -a он будет отображать все конечные точки соединения (TCP и UDP), установленные или нет.
	
- Psloglist отображает содержимое журналов событий. По умолчанию Psloglist выводит системный журнал, но его можно использовать для вывода других журналов с помощью команды psloglist имя_журнала. Если команда используется для вывода журналов службы каталогов или службы репликации файлов, укажите их имена в кавычках.
	- Программа также способна выгружать записи с определенной даты, если ее запустить с опцией -a, например:
	> psloglist security -a 01.01.05.
	  	
	- Крайне важно помнить, что ваша система изначально должна быть настроена на ведение журнала важных событий. Стандартные события, регистрируемые Windows, просто не предоставляют достаточно подробной информации о взломе.
		
	- Минимум, который необходимо сделать - включить аудит изменений политики, использования привилегий и событий входа в систему в локальной политике безопасности (раздел "Административные инструменты" панели управления). Доступ к политике можно также получить с помощью оснастки mmc.
		
	- Вы также можете захотеть контролировать доступ к важным или конфиденциальным данным (это можно настроить, щелкнув правой кнопкой мыши по любому файлу или папке, выбрав "Свойства" и перейдя на вкладку "Безопасность" -> "Дополнительно").
	
	
Иногда известно, что система взломана, но неизвестно, является ли атака работой самораспространяющегося вредоносного ПО или злоумышленника в лице человека. Если вы не найдете никаких доказательств вируса или червя, которые объясняют ранее наблюдавшиеся события, возможно, стоит рассматривать это как человеческую атаку до тех пор, пока не будет доказано обратное. На этом этапе вам следует отключить пораженную систему от сети и создать образ дисков. Если вы обнаружите на системе вредоносное ПО, убедитесь, что именно оно отвечает за все наблюдавшиеся события, а не является независимым или прикрытием для человеческой атаки.
	
</details>

<details>
<summary> Постер SANS по анализу артефактов Windows (нажмите, чтобы развернуть) </summary>

 [SANS_DFIR_FOR500_WINDOWS_FORENSICS_POSTER_v4.13.pdf](https://github.com/Starfflow/playbooks_runbooks/files/15444048/SANS_DFIR_FOR500_WINDOWS_FORENSICS_POSTER_v4.13.pdf)

</details>


</details>

---
 
![КомпрометацияУЗWIndows](https://github.com/Starfflow/playbooks_runbooks/assets/117627394/05f07c37-5d83-4864-9cd9-8bbed93f16b3)

---
# Этапы реагирования на инцидент

<details>
  <summary>Развернуть</summary>
	
## ПОДГОТОВКА

<details>
<summary> Развернуть </summary>    


**Проверка коммуникаций:**

- Проверить четкое определение ролей и обязанностей технического персонала и других отделов во время реагирования на кибер-инциденты. Убедиться, что каждый участник понимает свои задачи и действия в случае возникновения инцидента.
- Определить критерии эскалации инцидента на уровень руководства. Установить четкий процесс передачи информации и ответственности при эскалации.
- Создать готовые формы сообщений об инциденте для пользователей, CERT и иных заинтересованных лиц
- Будьте готовы уведомить группы реагирования на инциденты безопасности, правоохранительные органы и регулирующие органы, если это требуется во время инцидента.

**Должен существовать и быть доступным список активов и их владельцев для следующих категорий:**

- Активы клиентов:
	- Владельцы
	- Контактные лица
- Активы компании (включая все филиалы и подразделения): 
	- Владельцы
	- Контактные лица
	- Администраторы
- Инвентаризация инфраструктуры: 
	- Конечные точки (компьютеры, ноутбуки, мобильные устройства)
	- Серверы
	- Сетевое оборудование
	- Системы безопасности, СЗИ
	- Диапазоны сети: 
		- Публичная
		- Частная
		- VPN / Внеполосные данные
	- Всех доменов в компании
		- Всех людей, которые могут регистрировать домены
	- Сотрудники
	- Партнеры
	- Клиенты

**Обзор угроз, новых рисков и уязвимостей:**

- Изучить актуальные угрозы в киберпространстве, нацеленные на вашу организацию, поставщиков и отрасль.
- Анализировать общие тенденции и новые типы атак, чтобы быть готовым к ним.
- Внедрить процессы threat intelligence

**Обеспечение доступа к необходимой документации и информации, в том числе вне рабочего времени, к:**

- Плану реагирования на кибер-инциденты
- Схеме сетевой архитектуры 
- Схеме потоков данных 
- Ключевым документам, необходимым для реагирования на инциденты

**Проведение регулярных кампаний для информирования сотрудников о рисках информационной безопасности, включая:**

- Фишинговые атаки / вредоносные электронные письма: 
	- Обучить сотрудников распознавать признаки фишинговых писем и избегать нажатия на подозрительные ссылки или вложения.
	- Предоставить инструкции о том, как безопасно обрабатывать электронную почту.
	- Провести симуляцию фишинговой атаки.
- Программы-вымогатели: 
	- Объяснить сотрудникам, что такое программы-вымогатели и как они могут нанести ущерб организации.
	- Предоставить рекомендации по предотвращению заражения вредоносным ПО и действий в случае атаки.
	- Провести симуляцию атаки вымогателя.
- Возможность сообщения о подозрении на киберинцидент: 
- Установить четкий процесс и каналы связи для сообщения о подозрительной активности, связанной с безопасностью.
- Поощрять сотрудников сообщать о любых инцидентах, не опасаясь негативных последствий.

**Обеспечение регулярного обучения по безопасности для сотрудников, управляющих персональными, конфиденциальными или критическими данными и системами:**

- Обязательное прохождение специализированных тренингов по безопасности для сотрудников, которые работают с чувствительной информацией.
- Регулярное обновление знаний и навыков сотрудников в области защиты данных и реагирования на угрозы.
- Проводить тренировку отдела безопасности в части реагирования (например, киберучения)

**Подготовка инфраструктуры:**

- Пропатчить уязвимости информационных активов
- Провести плановые проверки средств управления и СЗИ; обеспечить поддержку обновлений EDR/AV приложений, пересмотреть правила IDS/IPS, FW на соответствие
- Провести плановые проверки наличия и состояния резервных копий (+ что резервные копии не заражены ВПО).
- Проверить расшаренные директории на наличие открытых привилегий
- Сегментировать сеть и логировать траффик между сегментами. Убедиться в возможности изоляции сегментов, регионов, партнеров или Интернета.
- Внедрить deception-систему.
- Уделить внимание анти-фишинговым решениям и мониторингу появления процессов PS, CMD, WMI, MSHTA и тд.
- Настроить SIEM-систему для выявления подозрительной активности и автоматического оповещения о потенциальных угрозах. Определить четкие критерии, по которым система будет генерировать оповещения.
- Автоматизировать процессы реагирования в SOAR/IRP
- Логи журналов системных компонентов (События пользователей/аутентификации, AD, VPN, Удаленный доступ…) должны храниться минимум 90 дней в защищенных системах, например, в SIEM
- Убедиться, что серверы и АРМ авторизуются через единый центр
- Ограничить доступ к RDP, SSH и прочим протоколам
- Ограничить пользователей до минимально требуемых привилегий

**Парольная политика:**

- Не позволять использование старых паролей
- Цикл смены паролей в соответствии с лучшими практиками 
- Обеспечить требования к паролю

Развертывание решения EDR на конечных точках и серверах:

- Этот инструмент стал одним из краеугольных камней реагирования на инциденты в случае программ-вымогателей или крупномасштабных компрометаций, облегчая фазы идентификации, изоляции и восстановления.
- Установить политики EDR в режим предотвращения

**Подготовка к инциденту:**

- Необходимо подготовить профили сбора данных для EDR или инструментов вроде FastIR, DFIR Orc, KAPE.
- Необходимо хорошее знание обычной сетевой активности машины/сервера. У вас должен быть файл в надежном месте, описывающий обычную активность портов, для эффективного сравнения с текущим состоянием.
- Хорошее знание служб, обычно работающих на машине, может быть очень полезным. Не стесняйтесь обращаться за помощью к специалисту по Windows, если это применимо. Также хорошей идеей является наличие карты всех служб/запущенных процессов машины.

**Знание собственной инфраструктуры:**

- Работа в большой корпоративной среде, где все пользовательские машины одинаковы и устанавливаются с мастер-образа, может быть реальным преимуществом. Имейте карту всех процессов/служб/приложений. В такой среде, где пользователям запрещено устанавливать программное обеспечение, считайте любой дополнительный процесс/службу/приложение подозрительным.
- Чем больше вы знаете о чистом состоянии машины, тем больше у вас шансов обнаружить любую мошенническую деятельность, выполняющуюся с нее.


</details>


## ВЫЯВЛЕНИЕ

<details>
<summary> Развернуть </summary>

**Анализ каналов выявления:**

- Тикеты (заявки)
- SIEM (система управления информационной безопасностью и событиями)
- Антивирус / EDR
- Ошибки почтовых серверов, обнаружения с почтовых фильтров
- Метаданные приложений на наличие подозрительных user-agent  записей
- Использование TOR или I2P, истории поиска
- Необычная активность на ПК, серверах или телефонах
- Появление необычных/потенциально вредоносных файловых расширений, необычные исполняемые бинарные файлы в пользовательской среде
- Информация от deception-систем
- Необычный DNS-трафик
- Необычные изменения профиля, например изменение имени, номера телефона или почтового индекса.
- Необычные изменения учетных данных, например многократное изменение пароля

**Анализ уведомлений:**

Уведомления поступают из внешних источников, обычно по электронной почте, Teams или по телефону. Основные источники уведомлений:

- Внутренние пользователи (Пользователи компании)
- Получатели писем (Люди, которым отправляются письма извне компании)
- Сторонние организации (Компании или службы, не являющиеся частью вашей организации)
- Интернет-провайдеры
- Почтовые провайдеры
- Подтвердите, что по инциденту создан тикет/заявка. Если нет, создайте его вручную.
- Определите и начните документировать любое влияние/опыт конечного пользователя, связанный с проблемой. Результаты должны быть задокументированы в тикете/заявке, связанном с инцидентом.
- В случае автоматически созданных тикетов/заявок определите, какие внутренние оповещения/показатели в данный момент указывают на проблему (что стало причиной создания тикета?)

**False positive?**

- Подтвердите инцидент

**Отсутствие EDR:**

- При отсутствии EDR следует предоставить физический доступ к подозрительной системе forensic-эксперту. Физический доступ предпочтительнее удаленного доступа, поскольку хакер может обнаружить расследование, проводимое в системе (например, с помощью сетевого сниффера).
- Для целей форензик-экспертизы и сбора доказательств может потребоваться физическая копия жесткого диска. Наконец, при необходимости может потребоваться физический доступ для отключения подозрительной машины от любой сети.

**Срочное информирование о киберинциденте:**

- Проверить сообщения от СЗИ на факт ложного срабатывания (false positive)
- При подтверждении вредоносной активности шифровальщика, сообщить о ней через службу поддержки (Service Desk).
	- Если заявки еще не существует, создать новую с минимальной информацией.
- Подумать о том, чтобы уведомить и привлечь CERT к расследованию
- В установленные сроки уведомить ГосСОПКА/НКЦКИ/ФСБ при необходимости

**Определить факторы риска (подтвердить их поможет этап «анализа»):**

ИБ-факторы риска:

- Кража учетных данных: несанкционированный доступ к учетным записям сотрудников, клиентов или партнеров.
- Доставка вредоносного ПО: Распространение вирусов, программ-вымогателей или других вредоносных программ, наносящих ущерб системам.

Факторы риска, специфичные для бизнеса:

- Прямые финансовые убытки из-за кибератак.
- Утрата действующих контрактов из-за утечки данных или нарушения безопасности
- Клиенты отказываются продлевать контракты из-за проблем с безопасностью
- Необходимость снижать цены на услуги для привлечения клиентов после инцидентов
- Наложение штрафов со стороны государственных органов за нарушение законодательства о безопасности данных


- На основании выводов определить критичность инцидента.

**Сбор данных:**

Информация, которую следует собирать и документировать об инциденте

- Фиксирование скомпрометированных учетных записей
	- Определить тип учетной записи:
		- Учетная запись сотрудника / партнера / клиента или другая учетная запись
		- Система / приложение, для которой использовалась учетная запись
		- Доменная / локальная / сервисная / административная учетная запись
	- Записать имя аккаунта, владельца аккаунта, имя ПК или системы.
	- Какой уровень доступа у пользователя?
- Определение времени взлома
	- Определите вероятное время, когда учетные данные были скомпрометированы (любые действия с API, предпринятые после этого времени, следует считать вредоносными, а любые ресурсы, созданные после этого времени, следует считать скомпрометированными).

**Подготовка к этапу анализа:**

- Мобилизовать группу реагирования на инциденты кибербезопасности (ГРИИБ) для первоначального расследования кибер-инцидента. 
- Собрать первоначальные данные об инциденте (карточка инцидента), включая как минимум следующее:
	- Тип кибер-инцидента;
	- Куда сообщили о кибер-инциденте;
	- Количество пострадавших активов в организации (на начальном этапе) и увеличивается ли оно;
	- Идентификация вредоносного электронного письма, если оно есть;
	- Дополнительные отчеты, связанные с пострадавшими активами, включая журналы антивируса, системные журналы событий и журналы сетевого мониторинга;
	- Предварительная оценка воздействия на бизнес, критичность;
	- Любые текущие действия, предпринимаемые для устранения инцидента.
- Оповестить руководство в соответствии с планом эскалации

</details>


## АНАЛИЗ

<details>
<summary> Развернуть </summary>

> Проведение криминалистического анализа
> Инициируйте процедуры криминалистического анализа скомпрометированных систем. Это поможет определить начальный вектор атаки и индикаторы компрометации.

**Получение IoC из forensic-артефактов:**

Прежде чем предпринимать какие-либо другие действия, убедитесь, что вы сделали захват временной памяти, загрузив и запустив FTKImager, winpmem или другую утилиту с внешнего носителя. нергозависимые данные предоставляют ценную криминалистическую информацию и их довольно легко получить. Энергозависимые данные полезны для анализа истории командной строки, сетевых подключений и т.д. По возможности используйте программу "Volatility".

- Снятие образа раздела:
	- Используйте инструменты, такие как FastIR, DFIR Orc, KAPE с предварительно настроенными профилями.
- Или полный образ диска
	- С помощью инструментов типа dd, FTKImager и т.д.

Лучше запускать несколько из этих инструментов, чем только один.

**Анализ памяти:**

- Поиск вредоносных процессов
- Проверка библиотек DLL и дескрипторов процессов
- Проверка сетевых артефактов
- Поиск внедрения кода
- Проверка наличия руткитов
- Аномалии и временные метки MFT
- Анализ антивирусом/Yara/Sigma: 
	- Подключите образ системы в режиме чтения
	- Запустите сканирование антивирусом или Yara-правилами для быстрой проверки

**Выявление механизмов скрытности:**

Вредоносное ПО может использовать различные методы для скрытного запуска и постоянной работы на системе. Вот некоторые из них:

- Запланированные задачи
- Замена служб
- Создание служб
- Автозапуск из реестра и папки автозапуска
- Подмена порядка поиска библиотек DLL
- Заражение легитимных системных библиотек
- Локальная групповая политика
- Дополнения MS Office
- Скрытная загрузка до загрузки системы (изменение BIOS/UEFI/MBR)

> Для быстрой проверки можно использовать программу Microsoft Autoruns.

**Определить метод компрометации/вектор атаки (по полученным IoC  и опросом параллельно):**

- Фишинг для сбора учетных данных
- Сбор учетных данных с локальных систем
- Пароль, подобранный методом перебора
- Иное

- Проведите интервью с пострадавшим пользователем, чтобы собрать подробности о возможных точках компрометации. Примеры вопросов:

	- Получали ли вы подозрительные электронные письма?
	- Получали ли вы документы по электронной почте, которых не ожидали?
	- Вводили ли вы свои учетные данные после нажатия на ссылку или на веб-сайте?
	- Скачивали ли вы какое-либо новое программное обеспечение?
	- Замечали ли вы какие-либо аномальные действия на вашем рабочем компьютере?

**Выявлено ВПО?**

- Можно обратиться к плейбуку по ВПО
- Сохранить образец вредоносного ПО
- Проанализировать вредоносное ПО с помощью любых доступных инструментов, например:
- Собрать хэш файла с помощью команды PowerShell "Get-Filehash".
- Отправить хэш в общедоступные источники, такие как VirusTotal, Hybrid-Analysis и т. д.
	- Если в общедоступных источниках встречался этот хэш, запишите характеристики вредоносного ПО.
- Изолируйте зараженные системы, не выключайте их, если это абсолютно не необходимо.
- Сохранить систему(ы) для дальнейшего криминалистического исследования, включая анализ журналов, анализ MFT, глубокое сканирование на наличие вредоносных программ и т. д.
- Устранить все связанные индикаторы компрометации (IoC) в системе электронной почты, брандмауэре и других компонентах безопасности (EDR). Это могут быть:
	- Идентификаторы сообщений в спам-фильтрах, почтовом антивирусе и т. д. – данные фишинговых писем
	- Хэши файлов идентифицированного вредоносного ПО
	- Имена файлов вредоносного ПО
	- Строки User-Agent* веб-клиентов, которые использовались вредоносным ПО
	- IP-адреса / полные доменные имена
	- URL-адреса, к которым обращались пользователи

> *Агент пользователя – это компьютерная программа, представляющая пользователя и выполняющая действия от его лица, например, браузер в контексте Всемирной паутины.

> Обратите внимание: Неизвестное вредоносное ПО может остаться нераспознанным.

**После того, как был определен метод первоначального взлома, используйте собранные индикаторы компрометации (IoC) для поиска других жертв в системе:**

- Потенциальные данные для поиска по электронной почте: тема письма, название документа, хэш документа, URL-адрес из письма и т.д.
- Потенциальные данные для поиска в SIEM или журналах: IP-адреса, URL-адреса, имена рабочих станций и т.д.
- Определите скомпрометированные учетные записи (мануально)
- На основе полученной информации (тип доступа, информационная система, IoC…) определите скомпрометированные учетные записи и (или) системы.
- Проанализируйте журналы (ниже будет отдельный пункт)
- Проверьте наличие оповещений о вредоносном ПО и EDR оповещения для хостов, связанных со скомпрометированными учетными записями.
- Ищите фишинговые электронные письма. Фишинговые письма являются самым распространенным методом кражи учетных данных.
- Ищите электронные письма со ссылками на сайты для сбора учетных данных
- Проверьте историю веб-браузера пользователя, чтобы определить, посещал ли он потенциально вредоносные сайты
- Ищите потенциальное вредоносное ПО на рабочем компьютере пользователя:
	- Средства сбора учетных данных, такие как Mimikatz
	- Программное обеспечение для записи нажатий клавиш – кейлоггеры
	- И т.д.

**После определения области поражения:**

- Обновить списки:
- Пораженных конечных точек
- Пострадавших юридических лиц Компании
- Пострадавших клиентов
- Были ли идентифицированы все устройства? Если обнаружены новые индикаторы компрометации (IoC), инициализируйте новые проверки систем.
- Когда вы закончите идентификацию всех скомпрометированных:
	- Хостов
	- Приложений / систем
	- Данных
- И исследовали все:
	- URL-адреса
	- Домены
	- IP-адреса
        - Журналы (следующий этап)  
	- Порты
	- Файлы
	- Хеши (контрольные суммы)
Можно будет переходить дальше.

**Проверка журналов событий:**

Журналы событий могут содержать информацию о подозрительной активности. Проверьте следующие разделы:

- Журнал запланированных задач (создание и выполнение)
- Проверить планировщик задач на наличие новых автоматизированных задач и изучить ранее запущенные задачи
- События входа в учетную запись (+проверить подключения извне офиса)
	- Проверить системные журналы, которые отслеживают попытки аутентификации (за 48 часов до сообщенного инцидента и до настоящего времени). Подтвердить подлинность успешных/неудачных входов в систему пользователем. Аномалии при аутентификации (нетипичные хосты / системы, способы аутентификации, протоколы, клиентские приложения и т. д.) 
- Подозрительные локальные учетные записи
- Вредоносные службы
- Очистки журналов событий
- Журналы RDP/TSE (Terminal server)
- Журналы PowerShell
- Журналы SMB
- Проверить журналы, фиксирующие изменения файловой системы
	- Поиск логов учетной записи для проверки изменений файловой системы и попыток их внесения (например, дополнительные файлы, удаленные файлы, измененные файлы и т. д.)
- Если журналы недоступны, предполагайте, что злоумышленник получил доступ ко всем доступным данным.


**Оцените учетные записи жертв, чтобы определить, может ли в них содержаться конфиденциальная информация или имеют ли они доступ к конфиденциальной информации на центральном хранилище, таком как файловые серверы:**

- Это может потребовать обращения на другие источники, к которым имеют доступ эти пользователи/учетные записи, такие как OneDrive, Google Drive, SharePoint, файловые серверы и т.д.


**Определить, произошла ли утечка данных, и если да, то:**

- Обратиться к плейбуку по реагированию на утечки данных.
- Рассмотреть, целесообразно ли на данном этапе сообщать в РКН о подозреваемом или подтвержденном несанкционированном доступе к любым персональным данным.

**Хронология:**

- Соберите доказательства процессов и создайте единую хронологию с помощью инструментов вроде Log2timeline.
- Проанализируйте полученную хронологию с помощью TimelineExplorer или glogg (например).

**Дальнейшее расследование:**

- Если анализ в реальном времени не дал результатов, но система по-прежнему считается взломанной, следует немедленно начать оффлайн-расследование:
	- Проверьте сетевые общие ресурсы или любые общедоступные папки, которыми вы делитесь с другими пользователями, чтобы узнать, не распространилось ли вредоносное ПО через них.
	- В целом, попытайтесь выяснить, как злоумышленник проник в систему. Следует учитывать все зацепки. Если не найдено компьютерных доказательств взлома, никогда не забывайте, что он мог произойти путем физического доступа или соучастия/кражи информации у сотрудника.

**Уведомление внешних организаций:**

- Если в ходе расследования было обнаружено взаимодействие с внешней организацией, сообщите ей о любых компрометациях или проблемах. 
	- Это поможет предотвратить повторные атаки на пользователей вашей организации с того же скомпрометированного источника.
- Заблокируйте отправку электронных писем с доменов данной внешней организации в вашу организацию.


</details>

## СДЕРЖИВАНИЕ И УСТРАНЕНИЕ

<details>
<summary> Развернуть </summary>

**Продолжить мониторинг:**

- Связанных приходящих уведомлений
- Интернет-подключения
- Новые файлы, совпадающие с хэшем идентифицированного файла
- Включить EDR/AV сканирование на целевых системах атаки. Применить режим предотвращения EDR для всех выявленных IOC
- Сканирование всех активов на IOC в соответствии с профилем атаки

> Контролируйте удаление злоумышленника из инфраструктуры посредством постоянного мониторинга выявленных индикаторов компрометации (IOCs).

**Сохраните артефакты, системы и соответствующие резервные копии в зависимости от серьезности и масштаба проблемы:**

> Эти данные могут быть важны для будущего криминалистического анализа.

- При восстановлении или замене физических систем сохраните сами жесткие диски, твердотельные накопители или их полные криминалистические образы.
- При восстановлении или замене виртуальных машин сохраните их копию, полный (энергонезависимый) снимок или резервную копию системы.
- Сохраните любые временные данные, которые могли быть собраны во время фазы идентификации.
	- Это могут быть журналы регистрации, резервные копии, образцы вредоносных программ, образы памяти и т. д.
- После того, как все важные данные, оборудование и/или системы будут сохранены, замените или восстановите системы соответствующим образом.
- Проверить резервные копии на IoC в соответствии с профилем атаки для будущего восстановления

**Устраните присутствие злоумышленника в инфраструктуре:**

- Выполните различные действия по удалению злоумышленника из инфраструктуры в соответствии с полученными результатами анализа. Удалить все вредоносные файлы, установленные злоумышленником, и механизмы постоянства.

> ВНИМАНИЕ:
> Прежде чем приступать к сдерживанию и устранению, убедитесь, что вы на 100% определили область действия и защитили/ограничили периметр, чтобы запретить злоумышленнику проводить ответные действия. Убедитесь, что все точки опоры злоумышленников идентифицированы. При необходимости и возможности действуйте скрытно.

**До выполнения следующих действий необходимо:**

- По возможности изолировать скомпрометированные машины с помощью EDR
- При наличии возможности применить исправления (для операционной системы и приложений), если злоумышленник использовал известную уязвимость
- Временно ограничить доступ к учетным записям, замешанным в инциденте:
- Ограничить привилегии:
- Понизить права УЗ
	- Удалить из групп «администраторы»
	- Любые права, позволяющие воздействовать на другие УЗ
- Временно отключить/заблокировать взломанные УЗ
- Если необходимо, создать временные учетные записи для продолжения работы
- Проинформировать владельцев учетных записей о компрометации и предпринятых действиях
- Переименовать взломанную учетную запись
- Удалить кэшированные учетные данные с локальных хостов

**Сбрасываем пароль на всех скомпрометированных (в т.ч. потенциально) УЗ:**

> Некоторые расследования могут указывать на то, что скомпрометирована электронная почта клиента, а не его пароль.

- Сбросить пароли для всех скомпрометированных учетных записей перед их разблокировкой и/или создайте учетные записи для замены и (опционально) навсегда отключите затронутые учетные записи.
- Сбросить все пароли, связанные со всеми выявленными жертвами.
	- Начните со сброса паролей скомпрометированных учетных записей. 
- Включите многофакторную аутентификацию (MFA) везде, где это возможно
- Отключить возможность удаленного входа в учетные записи пользователей, если это возможно
- Аннулировать токены аутентификации для всех учетных записей выявленных жертв
	- Это относится к системе электронной почты и любым другим учетным записям, связанным с пострадавшими пользователями.

- Также сбросить пароли (опционально):
	- Доменные
	- Локальные
	- MFA
	- Krbtgt
	- VPN
- Отслеживать взломанные учетные записи на предмет дальнейших проблем



</details>

## ВОССТАНОВЛЕНИЕ

<details>
<summary> Развернуть </summary>

> Независимо от того, насколько глубоко хакер проник в систему, и знаний, которые вы могли получить о взломе, если система была взломана, лучшей практикой является полная переустановка системы с чистого образа и применение всех обновлений безопасности к вновь установленной системе.

- Восстановить пораженные системы из чистого резервного копирования, сделанного до заражения, если эти резервные копии доступны.
- Для систем, которые нельзя восстановить из резервной копии, переустановить системы из заведомо исправного образа / с нуля.

В случае, если это решение не может быть применено, вам следует:

- Изменить все пароли учетных записей системы
- Обновить парольную политику
- Восстановить все файлы, которые могли быть изменены злоумышленником (например, svchost.exe)
- Устранить все уязвимости и пробелы, выявленные во время расследования

Продолжайте мониторинг вредоносной активности, связанной с этим инцидентом, в течение длительного периода

</details>

## ПОСТ-ИНЦИДЕНТ

<details>
<summary> Развернуть </summary>

- Подготовить отчет об инциденте, включая все детали и действия, предпринятые для его устранения.
- Завершить процессы выявления уроков и управления проблемами с предыдущих этапов.
- Обеспечить соответствующие внутренние и внешние коммуникации об инциденте
- Внедрить в СЗИ полученные сигнатуры данной атаки; обновить правила детектирования в SIEM, Анти-спам (фильтры), EDR (готовые TTP или ручные настройки) и иных решениях
- Пересмотреть процесс харденинга инфраструктуры
- Если инцидент был вызван человеческой ошибкой:
	- Устроить соответствующее обучение сотрудников
	- Провести анализ первопричины для выявления и устранения уязвимостей.
	- Провести оценку работы сотрудников: продолжительность рабочего времени, сверхурочные, отгулы за переработку и расходы.

**Составление отчета о последействиях инцидента, который должен включать как минимум следующую информацию:**

- Детали причин и воздействия инцидента, а также действий, предпринятых для смягчения киберинцидента, включая даты, тип и местоположение инцидента, а также его влияние на пользователей; время, затраченное на реагирование. Оценить выплаченный выкуп или иной ущерб, штрафы от государственных органов.
- Действия, предпринятые соответствующими группами реагирования, поставщиками услуг и заинтересованными сторонами бизнеса, которые позволили возобновить нормальную работу.
- Анализ ошибок реагирования и рекомендации по улучшению действий, процессов или технологий в организации, чтобы предотвратить повторное возникновение подобного киберинцидента.
- Мониторинг каких прекурсоров и индикаторов должен осуществляться для предотвращения подобного рода инцидентов?
- Сделать вывод о проанализированных артефактах форензики.

**Подтверждение соответствия политик:**

- Подтвердить соответствие политик безопасности по всей организации.
- Перенастроить процессы и процедуры, требующие улучшения
- Обновить плейбуки, если что-то в ходе реагирования шло не так

**Также возможно:**

- Публикация внутренних коммуникаций для информирования и обучения сотрудников о атаках с использованием программ-вымогателей и повышении осведомленности о безопасности
- Публикация внешних коммуникаций, в соответствии с коммуникационной стратегией, для предоставления консультаций клиентам, взаимодействия с рынком и информирования прессы о киберинциденте, если это необходимо
	- Эти сообщения должны содержать ключевую информацию о киберинциденте, не ставя организацию в уязвимое положение и не провоцируя дальнейшие атаки 
- Поделиться TI-фидами


- Необходимо определить действия по улучшению процессов управления обнаружением вторжений в Windows, чтобы извлечь пользу из этого опыта.
- Профили инструментов сбора данных могут быть скорректированы для лучшего соответствия артефактам, обнаруженным во время расследования.

**Проведите совещание после инцидента для обсуждения следующих вопросов:**

- Какие действия были предприняты успешно во время расследования?
- Что не получилось во время расследования?
- Какие уязвимости или пробелы в системе безопасности организации были выявлены?
- Каким образом они будут устранены?
- Какие дополнительные шаги или действия помогли бы предотвратить инцидент?

**По необходимости внести изменения в следующее:**

- Процедуры аутентификации
- Сложность и использование паролей
- Сегментация сети
- Настройка СЗИ
- Безопасность приложений
- Пропатчить ОС и/или приложения
- Провести обучение сотрудников, ИТ-специалистов или группы реагирования на инциденты безопасности


</details>

</details>
